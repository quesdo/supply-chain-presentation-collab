// ===== MULTI-LANGUAGE PRESENTATION DATA =====
const translations = {
    en: {
        slides: [
            {
                text: "Virtual Twin of the Supply Chain\n\nIts role is simple:",
                media: null
            },
            {
                text: "To anticipate, prepare, and secure physical flows, with the main goal of increasing margin and increasing fulfillment, while minimizing sustainable impact through emitted CO2 Emissions.\n\nThe virtual twin mirrors the entire supply chain ecosystem:\nsuppliers, their capacities, inventories, real lead times, contractual commitments, logistics routes, and even geopolitical risks.",
                media: "SUP 1"
            },
            {
                text: "The result?\nOXOS ensures the right materials arrive at the right time, in the right place.\n\nBut more importantly, this virtual twin is generative.\nBy which we mean that our AI engine is generating new optimized scenarios at every moment.",
                media: "SUP 2"
            },
            {
                text: "It automatically simulates alternative scenarios, proposes Plan B, C, or D, recalculates risks, costs, and lead times, and continuously integrates real-world disruptions.\n\nHere's a concrete example:\na key aerospace & defense supplier announces that they will stop doing business with us in 2 months due to commercial priorities.\n\nNormally, resolving this major challenge would take the team weeks of time to investigate alternatives and calculate the impact.",
                media: "SUP 3"
            },
            {
                text: "However now, with the generative virtual twin of the supply chain we find the solution within minutes!\n\nA new sourcing scenario is generated,\nthe impact on production orders and customer deliveries is recalculated, alternative suppliers are evaluated, and the best cost–risk tradeoff is proposed.\n\nWith OXOS, we ensure we are a reliable partner to deliver to the demanding A&D customers on time.",
                media: "SUP 4"
            },
            {
                text: "- even in an unstable world.",
                media: "SUP Content"
            }
        ],
        buttons: {
            start: "Start Presentation",
            continue: "Continue",
            finish: "Finish",
            restart: "Restart Presentation"
        },
        endScreen: "<strong>Thank you</strong><br>Presentation Complete"
    },
    fr: {
        slides: [
            {
                text: "Jumeau Virtuel de la Supply Chain\n\nSon rôle est simple :",
                media: null
            },
            {
                text: "Anticiper, préparer et sécuriser les flux physiques, avec pour objectif principal d'augmenter la marge et le taux de service, tout en minimisant l'impact durable via les émissions de CO2.\n\nLe jumeau virtuel reflète l'ensemble de l'écosystème de la supply chain :\nfournisseurs, leurs capacités, stocks, délais réels, engagements contractuels, routes logistiques, et même les risques géopolitiques.",
                media: "SUP 1"
            },
            {
                text: "Le résultat ?\nOXOS garantit que les bons matériaux arrivent au bon moment, au bon endroit.\n\nMais plus important encore, ce jumeau virtuel est génératif.\nCe qui signifie que notre moteur IA génère de nouveaux scénarios optimisés à chaque instant.",
                media: "SUP 2"
            },
            {
                text: "Il simule automatiquement des scénarios alternatifs, propose des Plans B, C ou D, recalcule les risques, coûts et délais, et intègre continuellement les perturbations du monde réel.\n\nVoici un exemple concret :\nun fournisseur clé aérospatial & défense annonce qu'il cessera ses activités avec nous dans 2 mois pour des raisons commerciales.\n\nNormalement, résoudre ce défi majeur prendrait des semaines à l'équipe pour investiguer les alternatives et calculer l'impact.",
                media: "SUP 3"
            },
            {
                text: "Cependant maintenant, avec le jumeau virtuel génératif de la supply chain, nous trouvons la solution en quelques minutes !\n\nUn nouveau scénario d'approvisionnement est généré,\nl'impact sur les ordres de production et les livraisons clients est recalculé, des fournisseurs alternatifs sont évalués, et le meilleur compromis coût-risque est proposé.\n\nAvec OXOS, nous assurons d'être un partenaire fiable pour livrer aux clients A&D exigeants à temps.",
                media: "SUP 4"
            },
            {
                text: "- même dans un monde instable.",
                media: "SUP Content"
            }
        ],
        buttons: {
            start: "Démarrer la Présentation",
            continue: "Continuer",
            finish: "Terminer",
            restart: "Redémarrer la Présentation"
        },
        endScreen: "<strong>Merci</strong><br>Présentation Terminée"
    },
    es: {
        slides: [
            {
                text: "Gemelo Virtual de la Cadena de Suministro\n\nSu papel es simple:",
                media: null
            },
            {
                text: "Anticipar, preparar y asegurar los flujos físicos, con el objetivo principal de aumentar el margen y el cumplimiento, minimizando el impacto sostenible a través de las emisiones de CO2.\n\nEl gemelo virtual refleja todo el ecosistema de la cadena de suministro:\nproveedores, sus capacidades, inventarios, plazos reales, compromisos contractuales, rutas logísticas e incluso riesgos geopolíticos.",
                media: "SUP 1"
            },
            {
                text: "¿El resultado?\nOXOS garantiza que los materiales correctos lleguen en el momento correcto, en el lugar correcto.\n\nPero más importante aún, este gemelo virtual es generativo.\nLo que significa que nuestro motor de IA genera nuevos escenarios optimizados en cada momento.",
                media: "SUP 2"
            },
            {
                text: "Simula automáticamente escenarios alternativos, propone Planes B, C o D, recalcula riesgos, costos y plazos, e integra continuamente las disrupciones del mundo real.\n\nAquí un ejemplo concreto:\nun proveedor clave aeroespacial y de defensa anuncia que dejará de hacer negocios con nosotros en 2 meses por prioridades comerciales.\n\nNormalmente, resolver este desafío mayor tomaría semanas al equipo para investigar alternativas y calcular el impacto.",
                media: "SUP 3"
            },
            {
                text: "Sin embargo ahora, con el gemelo virtual generativo de la cadena de suministro, ¡encontramos la solución en minutos!\n\nSe genera un nuevo escenario de aprovisionamiento,\nse recalcula el impacto en órdenes de producción y entregas a clientes, se evalúan proveedores alternativos, y se propone el mejor equilibrio costo-riesgo.\n\nCon OXOS, aseguramos ser un socio confiable para entregar a tiempo a los exigentes clientes A&D.",
                media: "SUP 4"
            },
            {
                text: "- incluso en un mundo inestable.",
                media: "SUP Content"
            }
        ],
        buttons: {
            start: "Iniciar Presentación",
            continue: "Continuar",
            finish: "Finalizar",
            restart: "Reiniciar Presentación"
        },
        endScreen: "<strong>Gracias</strong><br>Presentación Completa"
    },
    de: {
        slides: [
            {
                text: "Virtueller Zwilling der Supply Chain\n\nSeine Rolle ist einfach:",
                media: null
            },
            {
                text: "Physische Flüsse antizipieren, vorbereiten und sichern, mit dem Hauptziel, Marge und Erfüllung zu erhöhen und gleichzeitig die nachhaltige Auswirkung durch CO2-Emissionen zu minimieren.\n\nDer virtuelle Zwilling spiegelt das gesamte Supply-Chain-Ökosystem wider:\nLieferanten, ihre Kapazitäten, Bestände, reale Lieferzeiten, vertragliche Verpflichtungen, Logistikrouten und sogar geopolitische Risiken.",
                media: "SUP 1"
            },
            {
                text: "Das Ergebnis?\nOXOS stellt sicher, dass die richtigen Materialien zur richtigen Zeit am richtigen Ort ankommen.\n\nAber noch wichtiger: Dieser virtuelle Zwilling ist generativ.\nDas bedeutet, dass unsere KI-Engine in jedem Moment neue optimierte Szenarien generiert.",
                media: "SUP 2"
            },
            {
                text: "Er simuliert automatisch alternative Szenarien, schlägt Plan B, C oder D vor, berechnet Risiken, Kosten und Lieferzeiten neu und integriert kontinuierlich reale Störungen.\n\nHier ein konkretes Beispiel:\nEin wichtiger Luft- und Raumfahrt- & Verteidigungslieferant kündigt an, dass er in 2 Monaten aus kommerziellen Gründen nicht mehr mit uns Geschäfte machen wird.\n\nNormalerweise würde es das Team Wochen kosten, um Alternativen zu untersuchen und die Auswirkungen zu berechnen.",
                media: "SUP 3"
            },
            {
                text: "Jetzt jedoch finden wir mit dem generativen virtuellen Zwilling der Supply Chain die Lösung innerhalb von Minuten!\n\nEin neues Beschaffungsszenario wird generiert,\ndie Auswirkungen auf Produktionsaufträge und Kundenlieferungen werden neu berechnet, alternative Lieferanten werden bewertet, und der beste Kosten-Risiko-Kompromiss wird vorgeschlagen.\n\nMit OXOS stellen wir sicher, ein zuverlässiger Partner zu sein, um pünktlich an anspruchsvolle A&D-Kunden zu liefern.",
                media: "SUP 4"
            },
            {
                text: "- selbst in einer instabilen Welt.",
                media: "SUP Content"
            }
        ],
        buttons: {
            start: "Präsentation Starten",
            continue: "Weiter",
            finish: "Beenden",
            restart: "Präsentation Neustarten"
        },
        endScreen: "<strong>Vielen Dank</strong><br>Präsentation Abgeschlossen"
    },
    zh: {
        slides: [
            {
                text: "供应链虚拟孪生\n\n它的作用很简单：",
                media: null
            },
            {
                text: "预测、准备和保障物理流，主要目标是提高利润率和履约率，同时通过减少CO2排放来最小化可持续影响。\n\n虚拟孪生镜像整个供应链生态系统：\n供应商、他们的产能、库存、实际交货期、合同承诺、物流路线，甚至地缘政治风险。",
                media: "SUP 1"
            },
            {
                text: "结果呢？\nOXOS确保正确的材料在正确的时间到达正确的地点。\n\n但更重要的是，这个虚拟孪生是生成式的。\n这意味着我们的AI引擎每时每刻都在生成新的优化场景。",
                media: "SUP 2"
            },
            {
                text: "它自动模拟替代场景，提出B、C或D计划，重新计算风险、成本和交货期，并持续整合现实世界的干扰。\n\n这里有一个具体例子：\n一家关键的航空航天和国防供应商宣布，由于商业优先事项，他们将在2个月后停止与我们的业务往来。\n\n通常，解决这一重大挑战需要团队数周时间来调查替代方案并计算影响。",
                media: "SUP 3"
            },
            {
                text: "然而现在，借助生成式供应链虚拟孪生，我们在几分钟内就找到了解决方案！\n\n生成新的采购场景，\n重新计算对生产订单和客户交付的影响，评估替代供应商，并提出最佳成本-风险权衡。\n\n借助OXOS，我们确保成为可靠的合作伙伴，按时向要求严格的航空航天和国防客户交付。",
                media: "SUP 4"
            },
            {
                text: "- 即使在不稳定的世界中。",
                media: "SUP Content"
            }
        ],
        buttons: {
            start: "开始演示",
            continue: "继续",
            finish: "完成",
            restart: "重新开始演示"
        },
        endScreen: "<strong>谢谢</strong><br>演示完成"
    }
};

// ===== STATE MANAGEMENT =====
let currentSlide = -1;
let activeMedia = null;
let soundStarted = false;
let currentLanguage = 'en';

// ===== SUPABASE STATE =====
let supabaseClient = null;
let realtimeChannel = null;
let sessionId = null;
let isLocalAction = false;

// Get current slides based on selected language
function getSlides() {
    return translations[currentLanguage].slides;
}

function getButtonText(key) {
    return translations[currentLanguage].buttons[key];
}

function getEndScreenText() {
    return translations[currentLanguage].endScreen;
}

// ===== SDK INTEGRATION =====
function toggleVisibility(actorName, visible) {
    console.log("toggleVisibility:", actorName, visible);
    window.parent.postMessage(JSON.stringify({
        action: "toggleVisibility",
        actor: actorName,
        visible: visible
    }), "*");
}

function showMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, true);
        activeMedia = mediaName;
        console.log(`Showing 3D object: ${mediaName}`);
    }
}

function hideMedia(mediaName) {
    if (mediaName) {
        toggleVisibility(mediaName, false);
        console.log(`Hiding 3D object: ${mediaName}`);
    }
}

function hideAllMedia() {
    const allMedia = ["SUP 1", "SUP 2", "SUP 3", "SUP 4", "SUP Content"];
    allMedia.forEach(media => {
        toggleVisibility(media, false);
    });
    activeMedia = null;
    console.log("All 3D objects hidden");
}

function hideASISSupplyChain() {
    toggleVisibility("AS IS Supply Chain", false);
    console.log("AS IS Supply Chain hidden");
}

// ===== LANGUAGE SELECTOR =====
function changeLanguage(lang) {
    currentLanguage = lang;
    console.log('Language changed to:', lang);

    if (currentSlide >= 0 && currentSlide < getSlides().length) {
        const slideText = document.querySelector('.slide-text');
        slideText.textContent = getSlides()[currentSlide].text;
    }

    const nextBtn = document.getElementById('nextBtn');
    const btnText = nextBtn.querySelector('.btn-text');

    if (currentSlide === -1) {
        btnText.textContent = getButtonText('start');
    } else if (currentSlide === getSlides().length - 1) {
        btnText.textContent = getButtonText('finish');
    } else if (currentSlide >= getSlides().length) {
        btnText.textContent = getButtonText('restart');
    } else {
        btnText.textContent = getButtonText('continue');
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', async () => {
    initStars();
    await initSupabase();
    initPresentation();
    initLanguageSelector();

    console.log("Supply Chain Presentation loaded - SDK ready");
    console.log("Supabase Real-time sync enabled - User ID:", window.USER_ID);
});

// ===== STARS CREATION =====
function initStars() {
    const starsContainer = document.getElementById('stars');
    const starCount = 150;

    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.className = 'star';

        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (Math.random() * 2 + 2) + 's';

        starsContainer.appendChild(star);
    }
}

// ===== LANGUAGE SELECTOR INITIALIZATION =====
function initLanguageSelector() {
    const languageSelector = document.getElementById('languageSelector');

    languageSelector.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            changeLanguage(btn.dataset.lang);
        });
    });
}

// ===== PRESENTATION LOGIC =====
function initPresentation() {
    const nextBtn = document.getElementById('nextBtn');
    const textContent = document.getElementById('textContent');

    hideAllMedia();
    toggleVisibility("Supply Chain Sound", false);

    setTimeout(() => {
        textContent.classList.add('show');
        nextBtn.classList.add('show');
    }, 300);

    nextBtn.addEventListener('click', nextSlide);
    updateProgress();
}

async function nextSlide() {
    if (!isLocalAction) {
        await updateSession({ current_slide: currentSlide + 1 });
    }

    nextSlideLocal();
}

function nextSlideLocal() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    if (!soundStarted) {
        toggleVisibility("Supply Chain Sound", true);
        soundStarted = true;

        // HIDE AS IS Supply Chain and SHOW SUP Content immediately when starting
        hideASISSupplyChain();
        showMedia("SUP Content");
    }

    currentSlide++;

    if (currentSlide >= getSlides().length) {
        showEndScreen();
        return;
    }

    textContent.classList.remove('show');
    textContent.classList.add('slide-out');

    setTimeout(() => {
        const slide = getSlides()[currentSlide];
        slideText.textContent = slide.text;

        if (slide.media) {
            showMedia(slide.media);
        }

        textContent.classList.remove('slide-out');
        textContent.classList.add('slide-in');

        setTimeout(() => {
            textContent.classList.remove('slide-in');
            textContent.classList.add('show');
        }, 100);

        if (currentSlide === getSlides().length - 1) {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('finish');
        } else {
            nextBtn.querySelector('.btn-text').textContent = getButtonText('continue');
        }

        updateProgress();
    }, 500);
}

function showEndScreen() {
    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    const nextBtn = document.getElementById('nextBtn');

    textContent.classList.remove('show');
    nextBtn.classList.remove('show');

    setTimeout(() => {
        slideText.innerHTML = getEndScreenText();
        textContent.classList.add('show');

        nextBtn.querySelector('.btn-text').textContent = getButtonText('restart');
        nextBtn.querySelector('.btn-icon').textContent = '↻';
        nextBtn.onclick = restartPresentation;

        setTimeout(() => {
            nextBtn.classList.add('show');
        }, 500);
    }, 600);
}

async function restartPresentation() {
    // Simply reload the page for a clean restart
    window.location.reload();
}

function restartPresentationLocal() {
    hideAllMedia();
    toggleVisibility("AS IS Supply Chain", true);
    toggleVisibility("Supply Chain Sound", false);

    currentSlide = -1;
    soundStarted = false;

    const nextBtn = document.getElementById('nextBtn');
    nextBtn.querySelector('.btn-text').textContent = getButtonText('start');
    nextBtn.querySelector('.btn-icon').textContent = '→';
    nextBtn.onclick = nextSlide;

    const textContent = document.getElementById('textContent');
    const slideText = textContent.querySelector('.slide-text');
    slideText.textContent = '';

    updateProgress();

    console.log("Presentation restarted");
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    const total = getSlides().length;
    const current = Math.max(0, currentSlide + 1);
    const percentage = (current / total) * 100;

    const barFill = document.createElement('div');
    barFill.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: ${percentage}%;
        background: linear-gradient(90deg, #1976d2, #4da6ff);
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 0 10px rgba(77, 166, 255, 0.8);
    `;

    progressBar.innerHTML = '';
    progressBar.appendChild(barFill);

    progressText.textContent = `${current} / ${total}`;
}

// ===== SUPABASE INITIALIZATION =====
async function initSupabase() {
    const { createClient } = supabase;
    supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    const { data, error } = await supabaseClient
        .from('supply_chain_presentation_session')
        .select('*')
        .single();

    if (error) {
        console.error('Error fetching Supply Chain presentation session:', error);
        return;
    }

    sessionId = data.id;
    console.log('Connected to Supply Chain presentation session:', sessionId);

    realtimeChannel = supabaseClient
        .channel('supply_chain_presentation_session_changes')
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'supply_chain_presentation_session'
            },
            handleSessionUpdate
        )
        .subscribe();

    console.log('Supply Chain Real-time subscription active');

    console.log('Current session state:', data.current_slide);
    if (data.current_slide > -1) {
        console.log('Presentation already in progress - waiting for real-time updates');
    }
}

// ===== SUPABASE SYNC FUNCTIONS =====
async function updateSession(updates) {
    const { error } = await supabaseClient
        .from('supply_chain_presentation_session')
        .update(updates)
        .eq('id', sessionId);

    if (error) {
        console.error('Error updating Supply Chain session:', error);
    }
}

function handleSessionUpdate(payload) {
    const newData = payload.new;
    console.log('Presentation session updated:', newData);

    if (newData.current_slide !== currentSlide) {
        syncToSlide(newData.current_slide);
    }
}

function syncToSlide(targetSlide) {
    isLocalAction = true;

    const diff = targetSlide - currentSlide;

    if (diff === 1) {
        nextSlideLocal();
    } else if (targetSlide === -1 && currentSlide !== -1) {
        restartPresentationLocal();
    }

    isLocalAction = false;
}
